{% extends "teacher/teacher_base.html" %}

{% block title %}
  {% if question %}Edit Question{% else %}Add Question{% endif %}
{% endblock %}

{% block content %}

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- DEBUG: QUESTION_EDITOR V2 LOADED -->
<!-- ðŸ”¥ QUESTION_EDITOR SOURCE = core/templates/teacher/question_editor.html -->


<style>
.editor-card {
  background: white;
  border-radius: 14px;
  padding: 26px;
  max-width: 1100px;
  margin: auto;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

.meta-grid {
  display: grid;
  grid-template-columns: 1.2fr 1.2fr 0.7fr 0.7fr 1fr;
  gap: 16px;
}


.meta-grid label {
  font-weight: 600;
  font-size: 14px;
}

.meta-grid select,
.meta-grid input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.section {
  margin-top: 22px;
}

.section label {
  font-weight: 600;
  display: block;
  margin-bottom: 6px;
}

.lo-box {
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 12px;
  max-height: 220px;
  overflow-y: auto;
  background: #fafafa;
}

.lo-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 8px;
  font-size: 14px;
}

.actions {
  margin-top: 28px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.btn {
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
}

.btn.green { background: #7cb342; color: white; }
.btn.red { background: #d32f2f; color: white; }

.ql-container {
  border-radius: 0 0 10px 10px;
}

.ql-toolbar {
  border-radius: 10px 10px 0 0;
}
.meta-grid select,
.meta-grid input {
  max-width: 100%;
}

</style>

<div class="editor-card">

<h1>{% if question %}Edit Question{% else %}Add Question{% endif %}</h1>

<form method="post" onsubmit="return syncQuillAndSubmit();">
{% csrf_token %}

<!-- ================= METADATA ROW 1 ================= -->
<div class="meta-grid meta-row-1">

  <div>
    <label>Grade</label>
    <select name="grade" id="gradeSelect" required>
      <option value="">Select</option>
      {% for g in grades %}
        <option value="{{ g.id }}" {% if question.grade_id == g.id %}selected{% endif %}>
          {{ g.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label>Subject</label>
    <select name="subject" id="subjectSelect" required>
      <option value="">Select</option>
      {% for s in subjects %}
        <option value="{{ s.id }}" {% if question.subject_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label>Marks</label>
    <input type="number" name="marks" min="1"
           value="{{ question.marks|default:1 }}">
  </div>

  <div>
    <label>Question Type</label>
    <select name="question_type" required>
      <option value="mcq" {% if question.question_type == "mcq" %}selected{% endif %}>MCQ</option>
      <option value="theory" {% if question.question_type == "theory" %}selected{% endif %}>Theory</option>
      <option value="structured" {% if question.question_type == "structured" %}selected{% endif %}>Structured</option>
      <option value="practical" {% if question.question_type == "practical" %}selected{% endif %}>Practical</option>
    </select>
  </div>

</div>

<!-- ================= METADATA ROW 2 ================= -->
<div class="meta-grid meta-row-2">

  <div>
    <label>Topic</label>
    <select name="topic" id="topicSelect" required>
      <option value="">Select topic</option>
    </select>
  </div>

  <div>
    <label>Exam Year</label>
    <select name="year">
      <option value="">â€”</option>
      {% for y in "2026,2025,2024,2023,2022,2021,2020,2019,2018,2017,2016,2015"|split:"," %}
        <option value="{{ y }}" {% if question.year|stringformat:"s" == y %}selected{% endif %}>
          {{ y }}
        </option>
      {% endfor %}
    </select>
  </div>

</div>

<!-- ================= LEARNING OBJECTIVES ================= -->
<div class="section">
  <label>Learning Objectives</label>
  <div id="loBox" class="lo-box">
    <em>Select a topic to load learning objectives</em>
  </div>
</div>

<!-- ================= QUESTION ================= -->
<div class="section">
  <label>Question Text</label>
  <div id="questionEditor"></div>
</div>

<!-- ================= ANSWER ================= -->
<div class="section">
  <label>Answer / Mark Scheme</label>
  <div id="answerEditor"></div>
</div>

<!-- Hidden fields -->
<input type="hidden" name="question_text" id="questionTextInput">
<input type="hidden" name="answer_text" id="answerTextInput">
<input type="hidden" name="los_selected" id="losSelectedInput">

<div class="actions">
  <button type="submit" class="btn green">Save</button>
  <a href="{% url 'question_library' %}" class="btn red">Cancel</a>
</div>

</form>
</div>

<!-- ================= QUILL ================= -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
const questionQuill = new Quill("#questionEditor", {
  theme: "snow",
  placeholder: "Type the question hereâ€¦"
});

const answerQuill = new Quill("#answerEditor", {
  theme: "snow",
  placeholder: "Type the answer / mark scheme hereâ€¦"
});

questionQuill.root.innerHTML = {{ question.question_text|default:"''"|safe }};
answerQuill.root.innerHTML = {{ question.answer_text|default:"''"|safe }};
</script>

<!-- ================= AJAX ================= -->
<script>
const gradeSelect = document.getElementById("gradeSelect");
const subjectSelect = document.getElementById("subjectSelect");
const topicSelect = document.getElementById("topicSelect");
const loBox = document.getElementById("loBox");

const selectedLOs = new Set({{ selected_lo_ids|default:"[]"|safe }});

function loadTopics() {
  topicSelect.innerHTML = "<option value=''>Select topic</option>";
  loBox.innerHTML = "<em>Select a topic to load learning objectives</em>";

  if (!gradeSelect.value || !subjectSelect.value) return;

  fetch(`/ajax/topics/?grade_id=${gradeSelect.value}&subject_id=${subjectSelect.value}`)
    .then(r => r.json())
    .then(data => {
      data.topics.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        {% if question %}
        if ({{ question.topic_id|default:"null" }} === t.id) opt.selected = true;
        {% endif %}
        topicSelect.appendChild(opt);
      });
      if (topicSelect.value) loadLOs(topicSelect.value);
    });
}

function loadLOs(topicId) {
  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(r => r.json())
    .then(data => {
      loBox.innerHTML = "";
      data.los.forEach(lo => {
        const label = document.createElement("label");
        label.className = "lo-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = lo.id;
        cb.checked = selectedLOs.has(lo.id);
        cb.onchange = () =>
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);

        label.appendChild(cb);
        label.insertAdjacentHTML("beforeend",
          `<strong>${lo.code}</strong> â€” ${lo.description}`);
        loBox.appendChild(label);
      });
    });
}

gradeSelect.onchange = loadTopics;
subjectSelect.onchange = loadTopics;
topicSelect.onchange = () => loadLOs(topicSelect.value);

loadTopics();

function syncQuillAndSubmit() {
  const qHTML = questionQuill.root.innerHTML.trim();
  const aHTML = answerQuill.root.innerHTML.trim();

  if (!qHTML || qHTML === "<p><br></p>") {
    alert("Question text is empty.");
    return false;
  }

  document.getElementById("questionTextInput").value = qHTML;
  document.getElementById("answerTextInput").value = aHTML;
  document.getElementById("losSelectedInput").value =
    Array.from(selectedLOs).join(",");

  return true;
}
</script>

{% endblock %}