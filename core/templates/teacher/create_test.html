{% extends "teacher/teacher_base.html" %}
{% load static %}

{% block title %}
  {{ test.title|default:"Create Test" }}
{% endblock %}

{% block content %}

<style>
.test-editor {
  max-width: 1200px;
  margin: auto;
}

.test-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.test-header input {
  font-size: 20px;
  padding: 10px 14px;
  width: 60%;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.status {
  display: flex;
  gap: 16px;
  align-items: center;
  font-size: 14px;
}

#autosaveStatus {
  color: #4caf50;
}

.question-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.question-card {
  background: white;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  border: 1px solid #e0e0e0;
  position: relative;
}

.drag-handle {
  position: absolute;
  left: 12px;
  top: 18px;
  cursor: grab;
  color: #777;
}

.question-body {
  margin-left: 26px;
}

.q-actions {
  margin-top: 10px;
  display: flex;
  gap: 12px;
}

.q-actions a,
.q-actions button {
  background: none;
  border: none;
  color: #2563eb;
  cursor: pointer;
  font-size: 14px;
}

.right-panel {
  position: fixed;
  right: 30px;
  top: 140px;
  width: 260px;
}

.right-panel .btn {
  display: block;
  width: 100%;
  margin-bottom: 12px;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
}
</style>

<div class="test-editor">

  <!-- HEADER -->
  <div class="test-header">
    <input
      id="testTitle"
      placeholder="Test title"
      value="{{ test.title|default_if_none:'' }}"
    >

    <div class="status">
      <label>
        <input type="checkbox" id="publishToggle"
               {% if test.is_published %}checked{% endif %}>
        Published
      </label>
      <span id="autosaveStatus">Saved</span>
    </div>
  </div>

  <!-- QUESTIONS -->
  <div id="questionList" class="question-list">
    {% for tq in questions %}
    <div class="question-card" data-id="{{ tq.id }}">
      <span class="drag-handle">â˜°</span>

      <div class="question-body">
        {{ tq.question.question_text|safe }}
      </div>

      <div class="q-actions">
        <a href="{% url 'edit_question' tq.question.id %}" target="_blank">
          Edit
        </a>
        <button data-remove="{{ tq.id }}">Remove</button>
      </div>
    </div>
    {% empty %}
      <p><em>No questions added yet.</em></p>
    {% endfor %}
  </div>

</div>

<!-- RIGHT PANEL -->
<div class="right-panel">
  <a href="/questions/?mode=import&test_id={{ test.id }}"
     target="_blank"
     class="btn">
     Import from Library
  </a>

  <a href="{% url 'add_question' %}"
     target="_blank"
     class="btn">
     Type New Question
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
/* ================= DRAG TO SORT ================= */
new Sortable(document.getElementById("questionList"), {
  handle: ".drag-handle",
  animation: 150,
  onEnd: saveOrder
});

/* ================= AUTOSAVE ================= */
setInterval(autoSave, 10000);

function autoSave() {
  fetch("{% url 'autosave_test' test.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({
      title: document.getElementById("testTitle").value,
      published: document.getElementById("publishToggle").checked
    })
  }).then(() => {
    document.getElementById("autosaveStatus").textContent =
      "Saved " + new Date().toLocaleTimeString();
  });
}

function saveOrder() {
  const ids = [...document.querySelectorAll(".question-card")]
    .map(q => q.dataset.id);

  fetch("{% url 'reorder_test' test.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ order: ids })
  });
}
</script>

{% endblock %}
