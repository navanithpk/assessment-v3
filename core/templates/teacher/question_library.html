{% extends "teacher/teacher_base.html" %}

{% block title %}Question Library{% endblock %}

{% block content %}
{% with test_id=request.GET.import_to_test %}
{% with import_mode=test_id %}

<style>
h1 { margin-top: 0; }

.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.btn.green { background: #7cb342; color: white; }
.btn.gray { background: #9e9e9e; color: white; }
.btn.blue { background: #2563eb; color: white; }

.filters {
  background: white;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
}

.filters label {
  font-weight: 600;
  font-size: 13px;
}

.filters select,
.filters input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.topics,
.lo-box {
  margin-top: 12px;
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 12px;
  background: #fafafa;
}

.check-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 14px;
}

.check-item input {
  margin-top: 2px;
  width: 16px;
  height: 16px;
}

.table-wrap {
  background: white;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 10px;
  font-size: 14px;
}

th { background: #f1f1f1; }

tr:not(:last-child) td {
  border-bottom: 1px solid #e0e0e0;
}
</style>

<div class="action-bar">
  <h1>Question Library</h1>

  <div>
    {% if import_mode %}
      <button class="btn blue" onclick="importSelected()">⬇ Import Selected</button>
    {% endif %}

    <a href="{% url 'add_question' %}" target="_blank">
      <button class="btn green">➕ Add Question</button>
    </a>
  </div>
</div>

<form method="get" class="filters" id="filterForm">
  {% if import_mode %}
    <input type="hidden" name="import_to_test" value="{{ test_id }}">
  {% endif %}

  <div class="filter-grid">
    <div>
      <label>Grade *</label>
      <select id="gradeSelect" name="grade" required>
        <option value="">Select</option>
        {% for g in grades %}
          <option value="{{ g.id }}" {% if request.GET.grade == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Subject *</label>
      <select id="subjectSelect" name="subject" required>
        <option value="">Select</option>
        {% for s in subjects %}
          <option value="{{ s.id }}" {% if request.GET.subject == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Question Type</label>
      <select name="question_type">
        <option value="">Any</option>
        <option value="mcq" {% if request.GET.question_type == "mcq" %}selected{% endif %}>MCQ</option>
        <option value="theory" {% if request.GET.question_type == "theory" %}selected{% endif %}>Theory</option>
        <option value="structured" {% if request.GET.question_type == "structured" %}selected{% endif %}>Structured</option>
        <option value="practical" {% if request.GET.question_type == "practical" %}selected{% endif %}>Practical</option>
      </select>
    </div>

    <div>
      <label>Marks</label>
      <input type="number" name="marks" value="{{ request.GET.marks }}">
    </div>
  </div>

  <div class="topics" id="topicsBox">
    <strong>Topics *</strong>
    <em>Select grade & subject</em>
  </div>

  <div class="lo-box" id="loBox">
    <strong>Learning Objectives</strong>
    <em>Select topic</em>
  </div>

  <div style="margin-top:14px;">
    <button class="btn gray" type="submit">Apply Filters</button>
  </div>
</form>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        {% if import_mode %}
          <th><input type="checkbox" id="selectAll"></th>
        {% endif %}
        <th>Question</th>
        <th>Marks</th>
        <th>Type</th>
        <th>Grade</th>
        <th>Subject</th>
        <th>Topic</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for q in questions %}
      <tr>
        {% if import_mode %}
          <td>
            <input type="checkbox" class="q-check" value="{{ q.id }}">
          </td>
        {% endif %}
        <td>{{ q.question_text|striptags|truncatewords:18 }}</td>
        <td>{{ q.marks }}</td>
        <td>{{ q.question_type }}</td>
        <td>{{ q.grade.name }}</td>
        <td>{{ q.subject.name }}</td>
        <td>{{ q.topic.name }}</td>
        <td>
          <a href="{% url 'edit_question' q.id %}" target="_blank">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8"><em>No questions found</em></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const gradeSelect = document.getElementById("gradeSelect");
const subjectSelect = document.getElementById("subjectSelect");
const topicsBox = document.getElementById("topicsBox");
const loBox = document.getElementById("loBox");

const selectedTopics = new Set();
const selectedLOs = new Set();

function loadTopics() {
  if (!gradeSelect.value || !subjectSelect.value) {
    topicsBox.innerHTML = "<strong>Topics *</strong><em>Select grade & subject</em>";
    loBox.innerHTML = "<strong>Learning Objectives</strong><em>Select topic</em>";
    return;
  }

  topicsBox.innerHTML = "<em>Loading topics…</em>";
  loBox.innerHTML = "<em>Select topic</em>";

  fetch(`/ajax/topics/?grade_id=${gradeSelect.value}&subject_id=${subjectSelect.value}`)
    .then(r => r.json())
    .then(data => {
      topicsBox.innerHTML = "<strong>Topics *</strong>";
      data.topics.forEach(t => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = t.id;

        cb.onchange = () => {
          cb.checked ? selectedTopics.add(t.id) : selectedTopics.delete(t.id);
          loadLOs(t.id);
        };

        div.appendChild(cb);
        div.appendChild(document.createTextNode(t.name));
        topicsBox.appendChild(div);
      });
    })
    .catch(error => {
      console.error('Error loading topics:', error);
      topicsBox.innerHTML = "<strong>Topics *</strong><em>Error loading topics</em>";
    });
}

function loadLOs(topicId) {
  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(r => r.json())
    .then(data => {
      loBox.innerHTML = "<strong>Learning Objectives</strong>";
      data.los.forEach(lo => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = lo.id;

        cb.onchange = () => {
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);
        };

        div.appendChild(cb);
        div.insertAdjacentHTML(
          "beforeend",
          `<strong>${lo.code}</strong> – ${lo.description}`
        );

        loBox.appendChild(div);
      });
    })
    .catch(error => {
      console.error('Error loading LOs:', error);
    });
}

gradeSelect.onchange = loadTopics;
subjectSelect.onchange = loadTopics;

document.getElementById("filterForm").addEventListener("submit", e => {
  selectedTopics.forEach(t => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = "topics[]";
    i.value = t;
    e.target.appendChild(i);
  });

  selectedLOs.forEach(lo => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = "los[]";
    i.value = lo;
    e.target.appendChild(i);
  });
});

{% if import_mode %}
// Select all checkbox
document.getElementById("selectAll").onclick = function () {
  document.querySelectorAll(".q-check").forEach(cb => cb.checked = this.checked);
};

// Import selected questions
function importSelected() {
  const ids = [...document.querySelectorAll(".q-check:checked")].map(cb => cb.value);

  if (!ids.length) {
    alert("No questions selected");
    return;
  }

  const testId = "{{ test_id }}";
  
  fetch(`/teacher/tests/${testId}/add-questions/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ question_ids: ids })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'ok') {
      alert(`Successfully added ${ids.length} question(s) to the test!`);
      // Clear selections
      document.querySelectorAll(".q-check:checked").forEach(cb => cb.checked = false);
      document.getElementById("selectAll").checked = false;
    } else {
      alert("Error: " + (data.error || "Unknown error"));
    }
  })
  .catch(error => {
    console.error("Import error:", error);
    alert("Error importing questions. Please check the console and try again.");
  });
}
{% endif %}
</script>

{% endwith %}
{% endwith %}
{% endblock %}