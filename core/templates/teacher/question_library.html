{% extends "teacher/teacher_base.html" %}
{% block title %}Question Library{% endblock %}
{% block content %}

<style>
h1 { margin-top: 0; }

.action-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}

.btn {
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
}

.btn.green{background:#7cb342;color:white}
.btn.red{background:#d32f2f;color:white}
.btn.gray{background:#9e9e9e;color:white}

.filters {
  background:white;
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}

.filter-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}

.filters select,
.filters input {
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

.topics, .lo-box {
  margin-top:12px;
  max-height:160px;
  overflow-y:auto;
  border:1px solid #ccc;
  border-radius:8px;
  padding:10px;
  background:#fafafa;
}

/* ✅ checkbox alignment fix */
/* Container: vertical stack */
.topics,
.lo-box {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

/* Each checkbox row */
.check-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  width: 100%;
  margin-bottom: 6px;
}

/* Checkbox alignment */
.check-item input[type="checkbox"] {
  margin-top: 3px;   /* aligns with text baseline */
  flex-shrink: 0;
}

/* Text wraps nicely */
.check-item span,
.check-item strong {
  line-height: 1.4;
}

.table-wrap {
  background:white;
  border-radius:14px;
  padding:18px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}

table {
  width:100%;
  border-collapse:collapse;
}

th, td {
  padding:10px;
  font-size:14px;
}

th { background:#f1f1f1; }
tr:not(:last-child) td { border-bottom:1px solid #e0e0e0; }

.sort-bar { margin:12px 0; display:flex; gap:12px; }
</style>

<div class="action-bar">
  <h1>Question Library</h1>
  <a href="{% url 'add_question' %}" target="_blank">
    <button class="btn green">➕ Add Question to Library</button>
  </a>
</div>

<!-- FILTERS -->
<div class="filters">

  <div class="filter-grid">
    <div>
      <label>Grade *</label>
      <select id="gradeFilter">
        <option value="">Select</option>
        {% for g in grades %}
          <option value="{{ g.id }}">{{ g.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Subject *</label>
      <select id="subjectFilter">
        <option value="">Select</option>
        {% for s in subjects %}
          <option value="{{ s.id }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Question Type</label>
      <select id="typeFilter">
        <option value="">Any</option>
        <option value="mcq">MCQ</option>
        <option value="theory">Theory</option>
        <option value="structured">Structured</option>
        <option value="practical">Practical</option>
      </select>
    </div>

    <div>
      <label>Marks</label>
      <input type="number" id="marksFilter">
    </div>
  </div>

  <!-- TOPICS -->
  <div class="topics" id="topicsBox">
    <strong>Topics *</strong>
    <div id="topicsList"><em>Select grade & subject</em></div>
  </div>

  <!-- LOs -->
  <div class="lo-box">
    <strong>Learning Objectives</strong>
    <div id="loList"><em>Select topic</em></div>
  </div>

</div>

<div class="sort-bar">
  <a href="#" data-sort="marks">Sort by Marks</a>
  <a href="#" data-sort="latest">Latest</a>
  <a href="#" data-sort="oldest">Oldest</a>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th></th>
  <th>Question</th>
  <th>Marks</th>
  <th>Type</th>
  <th>Grade</th>
  <th>Subject</th>
  <th>Topic</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="questionsBody">
{% for q in questions %}
<tr>
  <td><input type="checkbox"></td>
  <td>{{ q.question_text|striptags|truncatewords:16 }}</td>
  <td>{{ q.marks }}</td>
  <td>{{ q.question_type }}</td>
  <td>{{ q.grade.name }}</td>
  <td>{{ q.subject.name }}</td>
  <td>{{ q.topic.name }}</td>
  <td><a href="{% url 'edit_question' q.id %}" target="_blank">Edit</a></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
const gradeFilter = document.getElementById("gradeFilter");
const subjectFilter = document.getElementById("subjectFilter");
const topicsList = document.getElementById("topicsList");
const loList = document.getElementById("loList");

const selectedTopics = new Set();
const selectedLOs = new Set();
let currentSort = null;

/* ---------------- Topics ---------------- */
function loadTopics() {
  topicsList.innerHTML = "<em>Loading topics…</em>";
  loList.innerHTML = "<em>Select topic</em>";

  if (!gradeFilter.value || !subjectFilter.value) return;

  fetch(`/ajax/topics/?grade_id=${gradeFilter.value}&subject_id=${subjectFilter.value}`)
    .then(r => r.json())
    .then(data => {
      topicsList.innerHTML = "";
      data.topics.forEach(t => {
        const row = document.createElement("div");
        row.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selectedTopics.has(t.id);

        cb.onchange = () => {
          cb.checked ? selectedTopics.add(t.id) : selectedTopics.delete(t.id);
          loadLOs(t.id);
          fetchQuestions();
        };

        row.append(cb, document.createTextNode(t.name));
        topicsList.appendChild(row);
      });
    });
}

/* ---------------- LOs ---------------- */
function loadLOs(topicId) {
  if (!topicId) return;
  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(r => r.json())
    .then(data => {
      data.los.forEach(lo => {
        if (document.getElementById(`lo-${lo.id}`)) return;

        const row = document.createElement("div");
        row.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = `lo-${lo.id}`;
        cb.checked = selectedLOs.has(lo.id);

        cb.onchange = () =>
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);

        row.append(cb);
        row.insertAdjacentHTML("beforeend",
          `<strong>${lo.code}</strong> — ${lo.description}`
        );
        loList.appendChild(row);
      });
    });
}

/* ---------------- Questions ---------------- */
function fetchQuestions() {
  const params = new URLSearchParams();

  if (gradeFilter.value) params.append("grade", gradeFilter.value);
  if (subjectFilter.value) params.append("subject", subjectFilter.value);
  if (currentSort) params.append("sort", currentSort);

  selectedTopics.forEach(t => params.append("topics[]", t));
  selectedLOs.forEach(lo => params.append("los[]", lo));

  fetch(`/ajax/questions/?${params}`)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById("questionsBody");
      body.innerHTML = "";

      if (!data.questions.length) {
        body.innerHTML = `<tr><td colspan="8"><em>No results</em></td></tr>`;
        return;
      }

      data.questions.forEach(q => {
        body.innerHTML += `
          <tr>
            <td><input type="checkbox"></td>
            <td>${q.text}</td>
            <td>${q.marks}</td>
            <td>${q.type}</td>
            <td>${q.grade}</td>
            <td>${q.subject}</td>
            <td>${q.topic}</td>
            <td><a href="/questions/edit/${q.id}/" target="_blank">Edit</a></td>
          </tr>`;
      });
    });
}

gradeFilter.onchange = loadTopics;
subjectFilter.onchange = loadTopics;

document.querySelectorAll(".sort-bar a").forEach(a =>
  a.onclick = e => {
    e.preventDefault();
    currentSort = a.dataset.sort;
    fetchQuestions();
  }
);
</script>

{% endblock %}
