{% extends "teacher/teacher_base.html" %}

{% block title %}Question Library{% endblock %}

{% block content %}

<style>
/* ==============================
   HEADER & ACTIONS
============================== */

h1 { margin-top: 0; }

.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.btn {
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
}

.btn.green { background: #7cb342; color: white; }
.btn.red { background: #d32f2f; color: white; }
.btn.gray { background: #9e9e9e; color: white; }

/* ==============================
   FILTER PANEL
============================== */

.filters {
  background: white;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
}

.filters label {
  font-weight: 600;
  font-size: 13px;
}

.filters select,
.filters input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

/* ==============================
   TOPICS & LO CONTAINERS
============================== */

.topics,
.lo-box {
  margin-top: 12px;
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 12px 14px;
  background: #fafafa;

  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* ==============================
   CHECKBOX ROW (FIX)
============================== */

.check-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  width: 100%;
  line-height: 1.4;
}

.check-item input[type="checkbox"] {
  margin: 0;
  margin-top: 3px;
  flex-shrink: 0;
  width: 16px;
  height: 16px;
  cursor: pointer;
}

.check-item span {
  font-size: 14px;
  color: #222;
}

.check-item strong {
  font-weight: 600;
}

.check-item:hover {
  background: rgba(0,0,0,.03);
  border-radius: 4px;
}

/* ==============================
   SORT BAR & TABLE
============================== */

.sort-bar {
  margin: 12px 0;
  display: flex;
  gap: 12px;
}

.table-wrap {
  background: white;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 10px;
  font-size: 14px;
}

th { background: #f1f1f1; }

tr:not(:last-child) td {
  border-bottom: 1px solid #e0e0e0;
}

.bulk-actions { margin-bottom: 12px; }
</style>

<div class="action-bar">
  <h1>Question Library</h1>

  <a href="{% url 'add_question' %}" target="_blank">
    <button class="btn green">➕ Add Question to Library</button>
  </a>
</div>

<!-- FILTERS -->
<form method="get" class="filters">

  <div class="filter-grid">

    <div>
      <label>Grade *</label>
      <select id="gradeSelect" name="grade" required>
        <option value="">Select</option>
        {% for g in grades %}
          <option value="{{ g.id }}">{{ g.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Subject *</label>
      <select id="subjectSelect" name="subject" required>
        <option value="">Select</option>
        {% for s in subjects %}
          <option value="{{ s.id }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Question Type</label>
      <select name="question_type">
        <option value="">Any</option>
        <option value="mcq">MCQ</option>
        <option value="theory">Theory</option>
        <option value="structured">Structured</option>
        <option value="practical">Practical</option>
      </select>
    </div>

    <div>
      <label>Marks</label>
      <input type="number" name="marks">
    </div>

    <div>
      <label>Exam Year</label>
      <input type="number" name="year">
    </div>

  </div>

  <!-- TOPICS -->
  <div class="topics" id="topicsBox">
    <strong>Topics *</strong>
    <em>Select grade & subject</em>
  </div>

  <!-- LEARNING OBJECTIVES -->
  <div class="lo-box" id="loBox">
    <strong>Learning Objectives</strong>
    <em>Select topic</em>
  </div>

  <div style="margin-top:14px;">
    <button class="btn gray" type="submit">Apply Filters</button>
  </div>

</form>

<!-- SORT -->
<div class="sort-bar">
  <a href="?sort=marks">Sort by Marks</a>
  <a href="?sort=latest">Latest</a>
  <a href="?sort=oldest">Oldest</a>
</div>

<!-- TABLE -->
<form method="post">
{% csrf_token %}

<div class="table-wrap">

  <div class="bulk-actions">
<button class="btn red"
        name="action"
        value="delete"
        onclick="return confirm('Delete selected questions permanently?')">
  Delete Selected
</button>
  </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>Question</th>
        <th>Marks</th>
        <th>Type</th>
        <th>Grade</th>
        <th>Subject</th>
        <th>Topic</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for q in questions %}
      <tr>
        <td><input type="checkbox" name="selected_questions" value="{{ q.id }}"></td>
        <td>{{ q.question_text|striptags|truncatewords:18 }}</td>
        <td>{{ q.marks }}</td>
        <td>{{ q.question_type }}</td>
        <td>{{ q.grade.name }}</td>
        <td>{{ q.subject.name }}</td>
        <td>{{ q.topic.name }}</td>
        <td>
          <a href="{% url 'edit_question' q.id %}" target="_blank">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="8"><em>No questions found</em></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>
</form>

<script>
document.getElementById("selectAll").onclick = function() {
  document.querySelectorAll('input[name="selected_questions"]').forEach(cb => {
    cb.checked = this.checked;
  });
};
</script>

<!-- AJAX LOGIC -->
<script>
const gradeSelect = document.getElementById("gradeSelect");
const subjectSelect = document.getElementById("subjectSelect");
const topicsBox = document.getElementById("topicsBox");
const loBox = document.getElementById("loBox");

/* persistent stores */
const selectedTopics = new Set();
const selectedLOs = new Set();

/* load topics */
function loadTopics() {
  topicsBox.innerHTML = "<em>Loading topics…</em>";
  loBox.innerHTML = "<em>Select topic</em>";

  fetch(`/ajax/topics/?grade_id=${gradeSelect.value}&subject_id=${subjectSelect.value}`)
    .then(r => r.json())
    .then(data => {
      topicsBox.innerHTML = "<strong>Topics *</strong>";
      data.topics.forEach(t => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = t.id;
        cb.checked = selectedTopics.has(t.id);

        cb.onchange = () => {
          cb.checked ? selectedTopics.add(t.id) : selectedTopics.delete(t.id);
          loadLOs(t.id);
        };

        const span = document.createElement("span");
        span.textContent = t.name;

        div.appendChild(cb);
        div.appendChild(span);
        topicsBox.appendChild(div);
      });
    });
}

/* load LOs */
function loadLOs(topicId) {
  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(r => r.json())
    .then(data => {
      loBox.innerHTML = "<strong>Learning Objectives</strong>";
      data.los.forEach(lo => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = lo.id;
        cb.checked = selectedLOs.has(lo.id);

        cb.onchange = () => {
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);
        };

        const span = document.createElement("span");
        span.innerHTML = `<strong>${lo.code}</strong> — ${lo.description}`;

        div.appendChild(cb);
        div.appendChild(span);
        loBox.appendChild(div);
      });
    });
}

gradeSelect.onchange = loadTopics;
subjectSelect.onchange = loadTopics;
</script>

{% endblock %}
