import React, { useState } from 'react';
import { ChevronDown, ChevronRight, Plus, Trash2, GripVertical, FileText } from 'lucide-react';

const AdvancedTestEditor = () => {
  const [testTitle, setTestTitle] = useState('Untitled Test');
  const [questions, setQuestions] = useState([
    {
      id: '1',
      level: 0,
      number: '1',
      content: 'Fig. 1.1 shows sea water flowing down a channel...',
      marks: 9,
      children: [
        {
          id: '1a',
          level: 1,
          number: '1(a)',
          content: 'Initially, the tank is empty. Calculate the depth...',
          marks: 3,
          children: []
        },
        {
          id: '1b',
          level: 1,
          number: '1(b)',
          content: 'The height of the water decreases by 0.420m...',
          marks: 3,
          children: []
        },
        {
          id: '1c',
          level: 1,
          number: '1(c)',
          content: 'The water stops flowing. Calculate the pressure...',
          marks: 3,
          children: []
        }
      ]
    },
    {
      id: '2',
      level: 0,
      number: '2',
      content: 'A pendulum swings with a time period...',
      marks: 6,
      children: [
        {
          id: '2a',
          level: 1,
          number: '2(a)',
          content: 'Describe how to use a stop-watch...',
          marks: 3,
          children: []
        },
        {
          id: '2b',
          level: 1,
          number: '2(b)',
          content: 'Complete Table 2.1 by writing...',
          marks: 3,
          children: []
        }
      ]
    }
  ]);

  const [expandedNodes, setExpandedNodes] = useState(new Set(['1', '2']));
  const [selectedQuestion, setSelectedQuestion] = useState(null);

  const toggleExpand = (id) => {
    const newExpanded = new Set(expandedNodes);
    if (newExpanded.has(id)) {
      newExpanded.delete(id);
    } else {
      newExpanded.add(id);
    }
    setExpandedNodes(newExpanded);
  };

  const addQuestion = (parentId = null, level = 0) => {
    const newQuestion = {
      id: `q-${Date.now()}`,
      level: level,
      number: level === 0 ? `${questions.length + 1}` : 'auto',
      content: '',
      marks: 1,
      children: []
    };

    if (parentId === null) {
      setQuestions([...questions, newQuestion]);
    } else {
      const addToParent = (qs) => {
        return qs.map(q => {
          if (q.id === parentId) {
            return { ...q, children: [...q.children, newQuestion] };
          }
          if (q.children.length > 0) {
            return { ...q, children: addToParent(q.children) };
          }
          return q;
        });
      };
      setQuestions(addToParent(questions));
      setExpandedNodes(new Set([...expandedNodes, parentId]));
    }
  };

  const deleteQuestion = (id) => {
    const removeQuestion = (qs) => {
      return qs.filter(q => q.id !== id).map(q => ({
        ...q,
        children: removeQuestion(q.children)
      }));
    };
    setQuestions(removeQuestion(questions));
  };

  const updateQuestion = (id, field, value) => {
    const updateInTree = (qs) => {
      return qs.map(q => {
        if (q.id === id) {
          return { ...q, [field]: value };
        }
        if (q.children.length > 0) {
          return { ...q, children: updateInTree(q.children) };
        }
        return q;
      });
    };
    setQuestions(updateInTree(questions));
  };

  const QuestionNode = ({ question, parentNumber = '' }) => {
    const isExpanded = expandedNodes.has(question.id);
    const hasChildren = question.children.length > 0;
    const indent = question.level * 24;

    // Auto-generate numbering
    const autoNumber = question.level === 0 
      ? question.number 
      : `${parentNumber}(${String.fromCharCode(97 + parseInt(question.id.split('-').pop() || 0) % 26)})`;

    return (
      <div style={{ marginLeft: `${indent}px` }}>
        <div 
          style={{
            background: selectedQuestion === question.id ? '#eff6ff' : 'white',
            border: '1px solid #e5e7eb',
            borderRadius: '8px',
            padding: '12px',
            marginBottom: '8px',
            cursor: 'pointer'
          }}
          onClick={() => setSelectedQuestion(question.id)}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            {hasChildren && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  toggleExpand(question.id);
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  padding: '4px'
                }}
              >
                {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
              </button>
            )}
            
            <GripVertical size={16} color="#9ca3af" />
            
            <div style={{ flex: 1 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                <span style={{ 
                  fontWeight: '600', 
                  color: '#2563eb',
                  fontSize: '14px'
                }}>
                  {autoNumber}
                </span>
                <input
                  type="number"
                  value={question.marks}
                  onChange={(e) => updateQuestion(question.id, 'marks', parseInt(e.target.value))}
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    width: '50px',
                    padding: '2px 6px',
                    border: '1px solid #d1d5db',
                    borderRadius: '4px',
                    fontSize: '12px'
                  }}
                />
                <span style={{ fontSize: '12px', color: '#6b7280' }}>marks</span>
              </div>
              
              <textarea
                value={question.content}
                onChange={(e) => updateQuestion(question.id, 'content', e.target.value)}
                onClick={(e) => e.stopPropagation()}
                placeholder="Enter question text..."
                style={{
                  width: '100%',
                  minHeight: '60px',
                  padding: '8px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '6px',
                  fontSize: '14px',
                  fontFamily: 'inherit',
                  resize: 'vertical'
                }}
              />
            </div>

            <div style={{ display: 'flex', gap: '4px' }}>
              {question.level < 3 && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    addQuestion(question.id, question.level + 1);
                  }}
                  style={{
                    padding: '6px',
                    background: '#dbeafe',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer'
                  }}
                  title="Add sub-question"
                >
                  <Plus size={16} color="#2563eb" />
                </button>
              )}
              
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  if (confirm('Delete this question and all sub-questions?')) {
                    deleteQuestion(question.id);
                  }
                }}
                style={{
                  padding: '6px',
                  background: '#fee2e2',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer'
                }}
              >
                <Trash2 size={16} color="#dc2626" />
              </button>
            </div>
          </div>
        </div>

        {isExpanded && hasChildren && (
          <div>
            {question.children.map(child => (
              <QuestionNode 
                key={child.id} 
                question={child} 
                parentNumber={autoNumber}
              />
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div style={{ 
      maxWidth: '1200px', 
      margin: '0 auto', 
      padding: '20px',
      fontFamily: 'system-ui, -apple-system, sans-serif'
    }}>
      {/* Header */}
      <div style={{
        background: 'white',
        borderRadius: '12px',
        padding: '24px',
        marginBottom: '20px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
      }}>
        <input
          type="text"
          value={testTitle}
          onChange={(e) => setTestTitle(e.target.value)}
          style={{
            width: '100%',
            fontSize: '24px',
            fontWeight: '600',
            border: 'none',
            borderBottom: '2px solid #e5e7eb',
            padding: '8px 0',
            marginBottom: '16px',
            outline: 'none'
          }}
        />
        
        <div style={{ display: 'flex', gap: '12px' }}>
          <button
            onClick={() => addQuestion(null, 0)}
            style={{
              padding: '10px 20px',
              background: '#2563eb',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              fontWeight: '500',
              display: 'flex',
              alignItems: 'center',
              gap: '6px'
            }}
          >
            <Plus size={18} />
            Add Main Question
          </button>
          
          <button
            style={{
              padding: '10px 20px',
              background: '#10b981',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              fontWeight: '500',
              display: 'flex',
              alignItems: 'center',
              gap: '6px'
            }}
          >
            <FileText size={18} />
            Import from Library
          </button>
        </div>
      </div>

      {/* Question Tree */}
      <div style={{
        background: 'white',
        borderRadius: '12px',
        padding: '24px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
      }}>
        <h3 style={{ margin: '0 0 20px 0', fontSize: '18px' }}>
          Questions ({questions.length})
        </h3>
        
        {questions.length === 0 ? (
          <div style={{
            textAlign: 'center',
            padding: '60px 20px',
            color: '#6b7280'
          }}>
            <FileText size={48} color="#d1d5db" style={{ margin: '0 auto 16px' }} />
            <p style={{ margin: 0 }}>No questions yet. Add your first question to get started.</p>
          </div>
        ) : (
          <div>
            {questions.map(question => (
              <QuestionNode key={question.id} question={question} />
            ))}
          </div>
        )}
      </div>

      {/* Info Panel */}
      <div style={{
        background: '#fffbeb',
        border: '1px solid #fde68a',
        borderRadius: '12px',
        padding: '16px',
        marginTop: '20px'
      }}>
        <h4 style={{ margin: '0 0 8px 0', color: '#92400e', fontSize: '14px' }}>
          ðŸ’¡ How to use this editor
        </h4>
        <ul style={{ margin: 0, paddingLeft: '20px', color: '#78350f', fontSize: '13px' }}>
          <li>Click "Add Main Question" to add top-level questions (1, 2, 3...)</li>
          <li>Click the + button on any question to add sub-questions (a, b, c...)</li>
          <li>Sub-questions can have their own sub-questions (i, ii, iii...)</li>
          <li>Questions from the library will be imported as individual items that you can nest</li>
          <li>Drag questions using the grip icon to reorder them</li>
        </ul>
      </div>
    </div>
  );
};

export default AdvancedTestEditor;