{% extends "student/student_base.html" %}

{% block title %}My Tests{% endblock %}

{% block header_title %}My Tests{% endblock %}
{% block header_subtitle %}View and attempt your assigned assessments{% endblock %}

{% block extra_css %}
<style>
  .tests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    padding: 32px;
  }

  .test-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .test-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--success));
    transform: scaleX(0);
    transition: transform 0.3s;
  }

  .test-card:hover {
    border-color: var(--primary);
    box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15);
    transform: translateY(-4px);
  }

  .test-card:hover::before {
    transform: scaleX(1);
  }

  .test-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
  }

  .test-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 8px;
    line-height: 1.3;
  }

  .test-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-upcoming {
    background: #dbeafe;
    color: #1e40af;
  }

  .status-live {
    background: #dcfce7;
    color: #166534;
    animation: pulse 2s infinite;
  }

  .status-completed {
    background: var(--gray-200);
    color: var(--gray-600);
  }

  .status-missed {
    background: #fee2e2;
    color: #991b1b;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .test-meta {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: var(--gray-600);
  }

  .meta-icon {
    width: 32px;
    height: 32px;
    background: var(--gray-100);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .test-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 20px 0;
    padding: 16px;
    background: var(--gray-50);
    border-radius: 12px;
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }

  .stat-label {
    font-size: 12px;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  .test-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: scale(1.02);
  }

  .btn-primary:disabled {
    background: var(--gray-300);
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: var(--gray-200);
    color: var(--gray-700);
  }

  .btn-secondary:hover {
    background: var(--gray-300);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-success:hover {
    background: #059669;
  }

  .empty-state {
    text-align: center;
    padding: 80px 20px;
  }

  .empty-icon {
    font-size: 80px;
    margin-bottom: 24px;
    opacity: 0.3;
  }

  .empty-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--gray-700);
    margin-bottom: 12px;
  }

  .empty-text {
    font-size: 16px;
    color: var(--gray-500);
    max-width: 400px;
    margin: 0 auto;
  }

  .timer-warning {
    background: #fef3c7;
    color: #92400e;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }

  .progress-bar {
    height: 6px;
    background: var(--gray-200);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 16px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--success));
    transition: width 0.3s;
  }

  /* Filter Tabs */
  .filter-tabs {
    display: flex;
    gap: 12px;
    padding: 24px 32px 0 32px;
    border-bottom: 2px solid var(--gray-200);
  }

  .filter-tab {
    padding: 12px 24px;
    background: none;
    border: none;
    font-weight: 600;
    color: var(--gray-500);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    margin-bottom: -2px;
  }

  .filter-tab:hover {
    color: var(--gray-700);
  }

  .filter-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  @media (max-width: 768px) {
    .tests-grid {
      grid-template-columns: 1fr;
      padding: 20px;
    }

    .test-stats {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="filter-tabs">
  <button class="filter-tab active" data-filter="all">All Tests</button>
  <button class="filter-tab" data-filter="upcoming">Upcoming</button>
  <button class="filter-tab" data-filter="live">Live Now</button>
  <button class="filter-tab" data-filter="completed">Completed</button>
</div>

{% if tests %}
<div class="tests-grid" id="testsGrid">
  {% for test_data in tests %}
  <div class="test-card" data-status="{{ test_data.status }}">
    <div class="test-header">
      <div>
        <h3 class="test-title">{{ test_data.test.title }}</h3>
      </div>
      <span class="test-status status-{{ test_data.status }}">
        {{ test_data.status }}
      </span>
    </div>

    <div class="test-meta">
      {% if test_data.test.start_time %}
      <div class="meta-item">
        <div class="meta-icon">üìÖ</div>
        <div>
          <strong>{{ test_data.test.start_time|date:"M d, Y" }}</strong>
          <br>
          <span style="font-size: 13px;">{{ test_data.test.start_time|time:"g:i A" }}</span>
        </div>
      </div>
      {% endif %}

      {% if test_data.test.duration_minutes %}
      <div class="meta-item">
        <div class="meta-icon">‚è±Ô∏è</div>
        <div>
          <strong>{{ test_data.test.duration_minutes }} minutes</strong>
        </div>
      </div>
      {% endif %}

      <div class="meta-item">
        <div class="meta-icon">üìù</div>
        <div>
          <strong>{{ test_data.question_count }} question{{ test_data.question_count|pluralize }}</strong>
        </div>
      </div>
    </div>

    <div class="test-stats">
      <div class="stat-item">
        <span class="stat-value">{{ test_data.total_marks }}</span>
        <span class="stat-label">Total Marks</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">
          {% if test_data.attempt %}
            {{ test_data.answered_count }}
          {% else %}
            0
          {% endif %}
        </span>
        <span class="stat-label">Answered</span>
      </div>
    </div>

    {% if test_data.attempt and not test_data.attempt.is_submitted %}
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ test_data.progress }}%"></div>
      </div>
    {% endif %}

    <div class="test-actions">
      {% if test_data.status == 'live' or test_data.status == 'upcoming' %}
        {% if test_data.attempt and not test_data.attempt.is_submitted %}
          <a href="{% url 'student_test_attempt' test_data.test.id %}" class="btn btn-success">
            ‚ñ∂Ô∏è Resume Test
          </a>
        {% elif test_data.can_start %}
          <a href="{% url 'student_test_attempt' test_data.test.id %}" class="btn btn-primary">
            üöÄ Start Test
          </a>
        {% else %}
          <button class="btn btn-primary" disabled>
            ‚è∞ Not Started
          </button>
        {% endif %}
      {% elif test_data.status == 'completed' %}
        <a href="{% url 'student_test_review' test_data.test.id %}" class="btn btn-secondary">
          üëÅÔ∏è View Results
        </a>
      {% endif %}
    </div>

    {% if test_data.time_until_start and test_data.status == 'upcoming' %}
      <div class="timer-warning">
        ‚è∞ Starts in {{ test_data.time_until_start }}
      </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <div class="empty-icon">üìö</div>
  <h2 class="empty-title">No Tests Available</h2>
  <p class="empty-text">
    You don't have any tests assigned yet. Check back later or contact your teacher.
  </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Filter functionality
const filterTabs = document.querySelectorAll('.filter-tab');
const testCards = document.querySelectorAll('.test-card');

filterTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    // Update active tab
    filterTabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    const filter = tab.dataset.filter;

    // Filter cards
    testCards.forEach(card => {
      if (filter === 'all') {
        card.style.display = 'block';
      } else {
        card.style.display = card.dataset.status === filter ? 'block' : 'none';
      }
    });
  });
});

// Auto-refresh for live tests every 30 seconds
if (document.querySelector('[data-status="live"]')) {
  setInterval(() => {
    location.reload();
  }, 30000);
}
</script>
{% endblock %}