<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if test %}Edit{% else %}Create{% endif %} Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #1a202c;
      line-height: 1.6;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Top Bar */
    .top-bar {
      background: white;
      border-bottom: 2px solid #e2e8f0;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .test-title-input {
      flex: 1;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-bottom: 2px solid transparent;
      padding: 8px 4px;
      outline: none;
      transition: border-color 0.2s;
    }

    .test-title-input:focus { border-bottom-color: #3b82f6; }

    .top-bar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .stat-badge {
      padding: 6px 12px;
      background: #f0f9ff;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #0369a1;
      white-space: nowrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main Layout */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 0;
      overflow: hidden;
    }

    .builder-panel {
      background: white;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #e2e8f0;
    }

    .builder-toolbar {
      padding: 12px 24px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .questions-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    /* Question Card */
    .question-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .question-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    }

    .question-header {
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .question-number {
      font-weight: 700;
      color: #3b82f6;
      font-size: 15px;
      min-width: 60px;
    }

    .question-marks {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .marks-input {
      width: 50px;
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }

    .question-actions {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }

    .icon-btn {
      padding: 6px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 4px;
      color: #6b7280;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: #e5e7eb;
      color: #1f2937;
    }

    .icon-btn.danger:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .question-body { padding: 16px; }

    .editor-section { margin-bottom: 16px; }

    .editor-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: block;
    }

    /* Rich Text Editor Fallback */
    .rich-editor {
      min-height: 80px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      outline: none;
      font-size: 14px;
      line-height: 1.6;
      transition: border-color 0.2s;
      background: white;
    }

    .rich-editor:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .editor-toolbar {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-bottom: none;
      border-radius: 6px 6px 0 0;
    }

    .toolbar-btn {
      padding: 4px 8px;
      border: none;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: #e5e7eb;
    }

    .toolbar-btn.active {
      background: #3b82f6;
      color: white;
    }

    .question-children {
      margin-left: 32px;
      margin-top: 12px;
    }

    /* LO Selection per Question */
    .lo-section {
      margin-top: 12px;
      padding: 12px;
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
    }

    .lo-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 8px;
    }

    .lo-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .lo-checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: white;
      border: 1px solid #bfdbfe;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lo-checkbox-item:hover {
      background: #dbeafe;
    }

    .lo-checkbox-item input {
      cursor: pointer;
    }

    /* Sidebar */
    .sidebar-panel {
      background: #fafbfc;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #4b5563;
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .assignment-preview {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .assignment-count {
      padding: 8px 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .assignment-count strong { color: #3b82f6; }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #9ca3af;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: white;
      border-radius: 12px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover { background: #f9fafb; }

    .checkbox-item.selected {
      background: #eff6ff;
      border-color: #3b82f6;
    }

    .checkbox-item input { margin-right: 12px; }

    .item-details { flex: 1; }

    .item-name {
      font-weight: 500;
      color: #111827;
      font-size: 14px;
    }

    .item-meta {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .shortcuts-hint {
      padding: 12px;
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
    }

    .kbd {
      display: inline-block;
      padding: 2px 6px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 3px;
      font-family: monospace;
      font-size: 11px;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .main-content { grid-template-columns: 1fr; }
      .sidebar-panel { display: none; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <input type="text" class="test-title-input" id="testTitle" placeholder="Untitled Test" value="">
      
      <div class="top-bar-actions">
        <div class="stat-badge"><span id="totalQuestions">0</span> Questions</div>
        <div class="stat-badge"><span id="totalMarks">0</span> Marks</div>
        <button class="btn btn-success" onclick="saveTest()">ðŸ’¾ Save</button>
        <button class="btn btn-primary" onclick="openAssignModal()">ðŸ‘¥ Assign</button>
        {% if test %}
        <button class="btn btn-primary" onclick="publishTest()">
          {% if test.is_published %}ðŸ”¥ Unpublish{% else %}ðŸ“¤ Publish{% endif %}
        </button>
        {% endif %}
      </div>
    </div>

    <div class="main-content">
      <div class="builder-panel">
        <div class="builder-toolbar">
          <button class="btn btn-primary" onclick="addQuestion()">âž• Add Question</button>
          <button class="btn btn-secondary" onclick="toggleAllExpanded()">ðŸ“½ Expand All</button>
        </div>

        <div class="questions-container" id="questionsContainer"></div>
      </div>

      <div class="sidebar-panel">
        <div class="sidebar-section">
          <div class="sidebar-title">ðŸ“‹ Test Settings</div>
          
          <div class="form-group">
            <label class="form-label">Grade</label>
            <select class="form-select" id="gradeSelect" onchange="loadTopics()">
              <option value="">Select Grade</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Subject</label>
            <select class="form-select" id="subjectSelect" onchange="loadTopics()">
              <option value="">Select Subject</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Topic</label>
            <select class="form-select" id="topicSelect" onchange="loadLOs()">
              <option value="">Select Topic</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Start Date & Time</label>
            <input type="datetime-local" class="form-input" id="startTime">
          </div>

          <div class="form-group">
            <label class="form-label">Duration (minutes)</label>
            <input type="number" class="form-input" id="duration" placeholder="e.g., 90" min="1">
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">ðŸ‘¥ Assignment</div>
          <div class="assignment-preview">
            <div class="assignment-count">
              <span>Students</span>
              <strong id="studentCount">0</strong>
            </div>
            <div class="assignment-count">
              <span>Groups</span>
              <strong id="groupCount">0</strong>
            </div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="openAssignModal()">
              Edit Assignments
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="shortcuts-hint">
            <strong>Shortcuts:</strong><br>
            <span class="kbd">Ctrl+N</span> New question<br>
            <span class="kbd">Ctrl+S</span> Save<br>
            <span class="kbd">Tab</span> Sub-question
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="assignModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Assign Students & Groups</div>
        <button class="icon-btn" onclick="closeAssignModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <input type="text" class="search-input" placeholder="Search students..." id="studentSearch" oninput="filterStudents()">
        <h3 style="margin-bottom: 12px; font-size: 16px;">Individual Students</h3>
        <div id="studentsList"></div>
        <h3 style="margin: 24px 0 12px; font-size: 16px;">Class Groups</h3>
        <div id="groupsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveAssignments()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // CSRF Token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // State
    let questions = [];
    let questionIdCounter = 0;
    let editors = new Map();
    let expandedQuestions = new Set();
    let availableLOs = [];
    let allStudents = [];
    let allGroups = [];
    let selectedStudents = new Set();
    let selectedGroups = new Set();

    // Load existing test data if editing
    {% if test %}
    const existingTestId = {{ test.id }};
    document.getElementById('testTitle').value = "{{ test.title|escapejs }}";
    
    {% if test.start_time %}
    document.getElementById('startTime').value = "{{ test.start_time|date:'Y-m-d\TH:i' }}";
    {% endif %}
    
    {% if test.duration_minutes %}
    document.getElementById('duration').value = {{ test.duration_minutes }};
    {% endif %}
    
    {% if questions_data %}
    try {
      const existingData = {{ questions_data|safe }};
      if (existingData && Array.isArray(existingData)) {
        questions = existingData;
        questionIdCounter = findMaxId(questions);
        expandAllQuestions(questions);
      }
    } catch (e) {
      console.error('Error loading questions:', e);
    }
    {% endif %}
    {% else %}
    const existingTestId = null;
    {% endif %}

    function findMaxId(qs) {
      let maxId = 0;
      qs.forEach(q => {
        const idNum = parseInt(q.id.toString());
        if (idNum > maxId) maxId = idNum;
        if (q.children && q.children.length > 0) {
          const childMax = findMaxId(q.children);
          if (childMax > maxId) maxId = childMax;
        }
      });
      return maxId;
    }

    function expandAllQuestions(qs) {
      qs.forEach(q => {
        expandedQuestions.add(q.id);
        if (q.children && q.children.length > 0) {
          expandAllQuestions(q.children);
        }
      });
    }

    // ===================== AJAX DROPDOWN LOADING =====================
    
    // Load initial data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadGrades();
      loadSubjects();
      render();
    });

    // Load all grades
    function loadGrades() {
      fetch('/ajax/grades/')
        .then(response => response.json())
        .then(data => {
          const gradeSelect = document.getElementById('gradeSelect');
          gradeSelect.innerHTML = '<option value="">Select Grade</option>';
          
          data.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade.id;
            option.textContent = grade.name;
            gradeSelect.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Error loading grades:', err);
        });
    }

    // Load subjects
    function loadSubjects() {
      fetch('/ajax/subjects/')
        .then(response => response.json())
        .then(data => {
          const subjectSelect = document.getElementById('subjectSelect');
          subjectSelect.innerHTML = '<option value="">Select Subject</option>';
          
          data.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.id;
            option.textContent = subject.name;
            subjectSelect.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Error loading subjects:', err);
        });
    }

    // Load topics based on grade AND subject
    function loadTopics() {
      const gradeId = document.getElementById('gradeSelect').value;
      const subjectId = document.getElementById('subjectSelect').value;
      const topicSelect = document.getElementById('topicSelect');
      
      if (!gradeId || !subjectId) {
        topicSelect.innerHTML = '<option value="">Select Topic</option>';
        clearLOs();
        return;
      }
      
      topicSelect.innerHTML = '<option value="">Loading topics...</option>';
      
      fetch(`/ajax/topics/?grade_id=${gradeId}&subject_id=${subjectId}`)
        .then(response => response.json())
        .then(data => {
          topicSelect.innerHTML = '<option value="">Select Topic</option>';
          
          if (data.length === 0) {
            topicSelect.innerHTML = '<option value="">No topics available</option>';
            clearLOs();
            return;
          }
          
          data.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.id;
            option.textContent = topic.name;
            topicSelect.appendChild(option);
          });
          
          clearLOs();
        })
        .catch(err => {
          console.error('Error loading topics:', err);
          topicSelect.innerHTML = '<option value="">Error loading topics</option>';
        });
    }

    // Load Learning Objectives based on topic
    function loadLOs() {
      const topicId = document.getElementById('topicSelect').value;
      
      if (!topicId) {
        clearLOs();
        return;
      }
      
      fetch(`/ajax/los/?topic_id=${topicId}`)
        .then(response => response.json())
        .then(data => {
          availableLOs = data || [];
          render();
        })
        .catch(err => {
          console.error('Error loading LOs:', err);
          availableLOs = [];
          render();
        });
    }

    function clearLOs() {
      availableLOs = [];
      render();
    }

    // ===================== RICH TEXT EDITOR =====================

    function createRichEditor(container, initialContent = '', onChange) {
      const wrapper = document.createElement('div');
      
      const toolbar = document.createElement('div');
      toolbar.className = 'editor-toolbar';
      toolbar.innerHTML = `
        <button type="button" class="toolbar-btn" onclick="formatDoc('bold', event)" title="Bold"><b>B</b></button>
        <button type="button" class="toolbar-btn" onclick="formatDoc('italic', event)" title="Italic"><i>I</i></button>
        <button type="button" class="toolbar-btn" onclick="formatDoc('underline', event)" title="Underline"><u>U</u></button>
        <button type="button" class="toolbar-btn" onclick="formatDoc('insertUnorderedList', event)" title="Bullet List">â€¢ List</button>
        <button type="button" class="toolbar-btn" onclick="formatDoc('insertOrderedList', event)" title="Numbered List">1. List</button>
      `;
      
      const editor = document.createElement('div');
      editor.className = 'rich-editor';
      editor.contentEditable = true;
      editor.innerHTML = initialContent || '<p><br></p>';
      
      editor.addEventListener('input', () => {
        if (onChange) onChange(editor.innerHTML);
      });
      
      wrapper.appendChild(toolbar);
      wrapper.appendChild(editor);
      container.appendChild(wrapper);
      
      return { element: editor, getContent: () => editor.innerHTML };
    }

    function formatDoc(command, event) {
      event.preventDefault();
      document.execCommand(command, false, null);
    }

    // ===================== QUESTION MANAGEMENT =====================

    function addQuestion() {
      const newQ = {
        id: ++questionIdCounter,
        number: questions.length + 1,
        content: '',
        markscheme: '',
        marks: 1,
        level: 0,
        children: [],
        los: []
      };
      questions.push(newQ);
      expandedQuestions.add(newQ.id);
      render();
    }

    function addSubQuestion(parentId) {
      const parent = findQuestionById(parentId);
      if (!parent || parent.level >= 2) return;
      
      const newChild = {
        id: ++questionIdCounter,
        content: '',
        markscheme: '',
        marks: 1,
        level: parent.level + 1,
        children: [],
        los: []
      };
      
      parent.children.push(newChild);
      expandedQuestions.add(parent.id);
      expandedQuestions.add(newChild.id);
      render();
    }

    function deleteQuestion(qId) {
      if (!confirm('Delete this question?')) return;
      
      for (let i = 0; i < questions.length; i++) {
        if (questions[i].id === qId) {
          questions.splice(i, 1);
          renumberQuestions();
          render();
          return;
        }
        if (deleteFromChildren(questions[i].children, qId)) {
          render();
          return;
        }
      }
    }

    function deleteFromChildren(children, qId) {
      for (let i = 0; i < children.length; i++) {
        if (children[i].id === qId) {
          children.splice(i, 1);
          return true;
        }
        if (deleteFromChildren(children[i].children, qId)) return true;
      }
      return false;
    }

    function renumberQuestions() {
      questions.forEach((q, idx) => {
        q.number = idx + 1;
      });
    }

    function updateMarks(qId, value) {
      const q = findQuestionById(qId);
      if (q) {
        q.marks = parseInt(value) || 1;
        updateStats();
      }
    }

    function toggleExpand(qId) {
      if (expandedQuestions.has(qId)) {
        expandedQuestions.delete(qId);
      } else {
        expandedQuestions.add(qId);
      }
      render();
    }

    function toggleAllExpanded() {
      if (expandedQuestions.size > 0) {
        expandedQuestions.clear();
      } else {
        expandAllQuestions(questions);
      }
      render();
    }

    function toggleQuestionLO(questionId, loId) {
      const question = findQuestionById(questionId);
      if (!question) return;
      
      if (!question.los) question.los = [];
      
      const index = question.los.indexOf(loId);
      if (index > -1) {
        question.los.splice(index, 1);
      } else {
        question.los.push(loId);
      }
    }

    // ===================== HELPER FUNCTIONS =====================

    function getQuestionNumber(question) {
      if (question.level === 0) return question.number;
      
      const parent = findParent(question.id);
      if (!parent) return '?';
      
      const parentNum = getQuestionNumber(parent);
      const index = parent.children.indexOf(question);
      
      if (question.level === 1) {
        return `${parentNum}(${String.fromCharCode(
		