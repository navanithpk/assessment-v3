{% extends "teacher/teacher_base.html" %}
{% load static %}

{% block title %}
  {% if test %}Edit Test{% else %}Create Test{% endif %}
{% endblock %}

{% block content %}

<style>
.test-page {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 24px;
}

.test-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.test-title {
  font-size: 22px;
  padding: 10px 14px;
  width: 100%;
  max-width: 520px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.test-actions {
  margin-bottom: 18px;
}

.btn {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

.btn.primary {
  background: #2563eb;
  color: white;
}

.btn.muted {
  background: #e5e7eb;
}

.questions {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.question-card {
  background: white;
  border-radius: 14px;
  padding: 16px;
  border: 1px solid #ddd;
  cursor: grab;
}

.question-card:active {
  cursor: grabbing;
}

.q-actions {
  margin-top: 10px;
  display: flex;
  gap: 12px;
}

.q-actions a,
.q-actions button {
  font-size: 13px;
  background: none;
  border: none;
  cursor: pointer;
  color: #2563eb;
}

.assign-panel {
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 18px;
}
</style>

<form method="post" id="testForm">
{% csrf_token %}

{% if test %}
<input type="hidden" name="test_id" value="{{ test.id }}">
{% endif %}

<div class="test-page">

  <!-- ================= MAIN ================= -->
  <main>

    <!-- HEADER -->
    <div class="test-header">
      <input
        type="text"
        name="title"
        class="test-title"
        placeholder="Test name"
        value="{{ test.title|default:'' }}"
        required
      >

      <label class="toggle">
        <input
          type="checkbox"
          name="is_published"
          {% if test.is_published %}checked{% endif %}
        >
        Published
      </label>
    </div>

    <!-- ACTIONS -->
    <div class="test-actions">
      {% if test %}
      <a
        href="{% url 'question_library' %}?import_to_test={{ test.id }}"
        target="_blank"
        class="btn primary"
      >
        ➕ Import from Question Library
      </a>
      {% endif %}
    </div>

    <!-- QUESTIONS -->
    <section class="questions" id="questionsArea">
      {% if questions %}
        {% for tq in questions %}
          <div
            class="question-card"
            draggable="true"
            data-id="{{ tq.question.id }}"
          >
            {{ tq.question.question_text|safe }}

            <div class="q-actions">
              <a href="{% url 'edit_question' tq.question.id %}" target="_blank">
                Edit
              </a>

              <button
                type="button"
                data-remove="{{ tq.question.id }}"
              >
                Remove
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="muted">No questions yet.</p>
      {% endif %}
    </section>

  </main>

  <!-- ================= ASSIGN ================= -->
  <aside class="assign-panel">
    <h3>Assign test</h3>
    <label><input type="checkbox"> Class 8A</label><br>
    <label><input type="checkbox"> Class 8B</label><br>
    <label><input type="checkbox"> Student – Rahul</label><br>
    <label><input type="checkbox"> Student – Ananya</label>
  </aside>

</div>

</form>

<!-- ================= AUTOSAVE ================= -->
<script>
let isDirty = false;

function markDirty() {
  isDirty = true;
}

function clearDirty() {
  isDirty = false;
}

/* Title typing */
document.querySelector(".test-title").addEventListener("input", markDirty);

/* Published toggle */
document.querySelector("input[name='is_published']")
  ?.addEventListener("change", markDirty);

/* Autosave loop */
setInterval(() => {
  if (!isDirty) return;

  const form = document.getElementById("testForm");
  const data = new FormData(form);

  fetch("", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
    body: data
  }).then(r => {
    if (r.ok) {
      console.log("Autosaved");
      clearDirty();
    }
  });
}, 5000);
</script>

<!-- ================= REMOVE QUESTION ================= -->
<script>
document.querySelectorAll("[data-remove]").forEach(btn => {
  btn.addEventListener("click", () => {
    fetch(`/teacher/tests/remove-question/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        test_id: {{ test.id }},
        question_id: btn.dataset.remove
      })
    }).then(() => {
      markDirty();
      location.reload();
    });
  });
});
</script>

<!-- ================= DRAG SORT ================= -->
<script>
let dragged;

document.querySelectorAll(".question-card").forEach(card => {
  card.addEventListener("dragstart", () => dragged = card);
  card.addEventListener("dragover", e => e.preventDefault());
  card.addEventListener("drop", e => {
    e.preventDefault();
    if (dragged !== card) {
      card.before(dragged);
      saveOrder();
    }
  });
});

function saveOrder() {
  markDirty();

  const ids = [...document.querySelectorAll(".question-card")]
    .map(c => c.dataset.id);

  fetch("/teacher/tests/reorder/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      test_id: {{ test.id }},
      order: ids
    })
  });
}
</script>

{% endblock %}
