{% extends "teacher/teacher_base.html" %}

{% block title %}
  {% if question %}Edit Question{% else %}Add Question{% endif %}
{% endblock %}

{% block content %}

<style>
.editor-card {
  background: white;
  border-radius: 14px;
  padding: 26px;
  max-width: 1100px;
  margin: auto;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

.meta-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 18px;
}

.meta-grid label {
  font-weight: 600;
  font-size: 14px;
}

.meta-grid select,
.meta-grid input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.section {
  margin-top: 20px;
}

.section label {
  font-weight: 600;
  display: block;
  margin-bottom: 6px;
}

.lo-box {
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 12px;
  max-height: 220px;
  overflow-y: auto;
  background: #fafafa;
}

.lo-item {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
}

.actions {
  margin-top: 26px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.btn {
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
}

.btn.green { background: #7cb342; color: white; }
.btn.red { background: #d32f2f; color: white; }
</style>

<div class="editor-card">

<h1>{% if question %}Edit Question{% else %}Add Question{% endif %}</h1>

<form method="post">
{% csrf_token %}

<!-- METADATA -->
<div class="meta-grid">

  <div>
    <label>Grade</label>
    <select name="grade" id="gradeSelect" required>
      <option value="">Select</option>
      {% for g in grades %}
        <option value="{{ g.id }}" {% if question.grade_id == g.id %}selected{% endif %}>
          {{ g.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label>Subject</label>
    <select name="subject" id="subjectSelect" required>
      <option value="">Select</option>
      {% for s in subjects %}
        <option value="{{ s.id }}" {% if question.subject_id == s.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label>Marks</label>
    <input type="number" name="marks" min="1" value="{{ question.marks|default:1 }}">
  </div>

  <div>
    <label>Question Type</label>
    <select name="question_type" required>
      <option value="mcq" {% if question.question_type == "mcq" %}selected{% endif %}>MCQ</option>
      <option value="theory" {% if question.question_type == "theory" %}selected{% endif %}>Theory</option>
      <option value="structured" {% if question.question_type == "structured" %}selected{% endif %}>Structured</option>
      <option value="practical" {% if question.question_type == "practical" %}selected{% endif %}>Practical</option>
    </select>
  </div>

</div>

<!-- TOPIC -->
<div class="section">
  <label>Topic</label>
  <select name="topic" id="topicSelect" required>
    <option value="">Select topic</option>
  </select>
</div>

<!-- LEARNING OBJECTIVES -->
<div class="section">
  <label>Learning Objectives</label>
  <div id="loBox" class="lo-box">
    <em>Select a topic to load learning objectives</em>
  </div>
</div>

<!-- QUESTION -->
<div class="section">
  <label>Question Text</label>
  <textarea name="question_text" class="tinymce">
{{ question.question_text|default_if_none:"" }}
  </textarea>
</div>

<!-- ANSWER -->
<div class="section">
  <label>Answer / Mark Scheme</label>
  <textarea name="answer_text" class="tinymce">
{{ question.answer_text|default_if_none:"" }}
  </textarea>
</div>

<input type="hidden" name="los_selected" id="losSelectedInput">

<div class="actions">
  <button type="submit" class="btn green">Save</button>
  <a href="{% url 'question_library' %}" class="btn red">Cancel</a>
</div>

</form>
</div>

<!-- TinyMCE -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"></script>
<script>
tinymce.init({
  selector: ".tinymce",
  height: 280,
  menubar: false,
  plugins: "lists table image code fullscreen autoresize",
  toolbar:
    "undo redo | bold italic underline | " +
    "alignleft aligncenter alignright | bullist numlist | table image | code fullscreen"
});
</script>

<!-- AJAX LOGIC -->
<script>
const gradeSelect = document.getElementById("gradeSelect");
const subjectSelect = document.getElementById("subjectSelect");
const topicSelect = document.getElementById("topicSelect");
const loBox = document.getElementById("loBox");

/* GLOBAL persistent LO store */
const selectedLOs = new Set({{ selected_lo_ids|default:"[]"|safe }});

/* Load topics by grade + subject */
function loadTopics() {
  const gradeId = gradeSelect.value;
  const subjectId = subjectSelect.value;

  topicSelect.innerHTML = "<option value=''>Select topic</option>";
  loBox.innerHTML = "<em>Select a topic to load learning objectives</em>";

  if (!gradeId || !subjectId) return;

  fetch(`/ajax/topics/?grade_id=${gradeId}&subject_id=${subjectId}`)
    .then(res => res.json())
    .then(data => {
      data.topics.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        topicSelect.appendChild(opt);
      });
    });
}

/* Load LOs for selected topic */
function loadLOs(topicId) {
  if (!topicId) return;

  loBox.innerHTML = "<em>Loading learning objectives…</em>";

  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(res => res.json())
    .then(data => {
      if (!data.los.length) {
        loBox.innerHTML = "<em>No learning objectives for this topic</em>";
        return;
      }

      loBox.innerHTML = "";

      data.los.forEach(lo => {
        const label = document.createElement("label");
        label.className = "lo-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = lo.id;
        cb.checked = selectedLOs.has(lo.id);

        cb.addEventListener("change", () => {
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);
        });

        label.appendChild(cb);
        label.insertAdjacentHTML(
          "beforeend",
          ` <strong>${lo.code}</strong> — ${lo.description}`
        );

        loBox.appendChild(label);
      });
    });
}

gradeSelect.addEventListener("change", loadTopics);
subjectSelect.addEventListener("change", loadTopics);
topicSelect.addEventListener("change", () => loadLOs(topicSelect.value));

/* Submit selected LOs */
document.querySelector("form").addEventListener("submit", () => {
  document.getElementById("losSelectedInput").value =
    Array.from(selectedLOs).join(",");
});
</script>

{% endblock %}
